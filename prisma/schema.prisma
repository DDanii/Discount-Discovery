// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/_db"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id       Int    @id @default(autoincrement())
  name     String @unique
  password String

  preferences Preference[]
  categoryPreferences CategoryPreference[]
  settings Settings?
}

model Settings {
  user   User @relation(fields: [userId], references: [id])
  userId Int  @unique

  ShopSettings    ShopSettings?
  productFilters  ProductFilters?
  categoryFilters CategoryFilters?
}

model ProductFilters {
  settings Settings @relation(fields: [userId], references: [userId])
  userId   Int      @unique

  liked    Boolean @default(true)
  disliked Boolean @default(true)
  neutral  Boolean @default(true)
}

model CategoryFilters {
  settings Settings @relation(fields: [userId], references: [userId])
  userId   Int      @unique

  liked    Boolean @default(true)
  disliked Boolean @default(true)
  neutral  Boolean @default(true)
}

model ShopSettings {
  settings Settings @relation(fields: [userId], references: [userId])
  userId   Int      @unique
  shop     Shop     @relation(fields: [shopId], references: [id])
  shopId   Int
  enabled  Boolean  @default(true)

  ArgumentSettings ArgumentSettings[]
}

model ArgumentSettings {
  shopArgument   ShopArguments @relation(fields: [shopArgumentId], references: [id])
  shopArgumentId Int
  shopSetting    ShopSettings  @relation(fields: [userId], references: [userId])
  userId         Int           @unique
  value          String
}

model ShopArguments {
  id           Int     @id @default(autoincrement())
  shop         Shop    @relation(fields: [shopId], references: [id])
  shopId       Int
  argument     String
  label        String
  required     Boolean @default(false)
  defaultValue String?

  ArgumentSettings ArgumentSettings[]

  @@unique([shopId, argument])
}

model Preference {
  id        Int      @id @default(autoincrement())
  user      User     @relation(fields: [userId], references: [id])
  userId    Int
  product   Product  @relation(fields: [productId], references: [id])
  productId Int
  value     Boolean?

  @@unique([userId, productId])
  @@map("Preference")
}

model Shop {
  id          Int       @id @default(autoincrement())
  source      String    @unique
  name        String
  icon        String?
  country     String?
  lastUpdated DateTime?

  products      Product[]
  shopSettings   ShopSettings[]
  shopArguments ShopArguments[]
}

model Product {
  id            Int       @id @default(autoincrement())
  externalId    String
  shop          Shop      @relation(fields: [shopId], references: [id])
  shopId        Int
  name          String?
  image         String?
  price         Float?
  startDate     DateTime
  endDate       DateTime
  url           String?
  pricePerUnit  Float?
  unit          String?
  description   String?
  warning       String?
  categoryModel Category? @relation(fields: [category], references: [name])
  category      String?

  preferences Preference[]

  @@unique([shopId, externalId])
}

model Category {
  name String @id

  products            Product[]
  categoryPreferences CategoryPreference[]
}

model CategoryPreference {
  id            Int      @id @default(autoincrement())
  categoryModel Category @relation(fields: [category], references: [name])
  category      String
  value         Boolean?
  user          User     @relation(fields: [userId], references: [id])
  userId        Int

  @@unique([userId, category])
}
